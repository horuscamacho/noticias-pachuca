# üîê CONTEXTO: Sistema de Autenticaci√≥n Mobile - Implementaci√≥n 2025

## üéØ OBJETIVO PRINCIPAL
Implementar un sistema de autenticaci√≥n robusto, seguro y moderno para la app mobile que integre:
- **Backend API NestJS** existente (11 endpoints disponibles)
- **TanStack Query** para estado del servidor
- **Zustand** para estado cliente
- **Almacenamiento seguro** con biometr√≠a
- **Auto-refresh** de tokens
- **Arquitectura escalable** siguiendo mejores pr√°cticas 2025

---

## üìã CHECKLIST DE IMPLEMENTACI√ìN COMPLETO

### üîß **FASE 1: CONFIGURACI√ìN BASE**

#### üì¶ **Dependencias y Configuraci√≥n**
- [ ] **Instalar dependencias de seguridad**
  ```bash
  expo install expo-secure-store expo-local-authentication
  yarn add react-native-encrypted-storage
  ```
- [ ] **Instalar dependencias de estado**
  ```bash
  yarn add zustand @tanstack/react-query-persist-client
  ```
- [ ] **Configurar variables de entorno**
  - [ ] `API_BASE_URL` para desarrollo y producci√≥n
  - [ ] `JWT_SECRET_KEY` para validaci√≥n local (opcional)
  - [ ] `ENABLE_BIOMETRICS` flag de feature

#### ‚öôÔ∏è **Configuraci√≥n Inicial**
- [ ] **Configurar TanStack Query Client**
  - [ ] QueryClient con configuraci√≥n mobile optimizada
  - [ ] Persistencia de cache con AsyncStorage
  - [ ] Error handlers globales para 401/403
- [ ] **Configurar Expo SecureStore**
  - [ ] Configuraci√≥n de biometr√≠a requerida
  - [ ] Fallback a PIN/contrase√±a
  - [ ] Validaci√≥n de hardware disponible

---

### üèóÔ∏è **FASE 2: ARQUITECTURA DE TIPOS**

#### üìù **Tipos del Sistema de Auth**
- [ ] **Definir interfaces del API (namespace API)**
  ```typescript
  // API.User, API.LoginRequest, API.LoginResponse, etc.
  ```
- [ ] **Definir interfaces de la App (namespace App)**
  ```typescript
  // App.User, App.LoginCredentials, App.TokenPair, etc.
  ```
- [ ] **Crear tipos de configuraci√≥n**
  ```typescript
  // AuthConfig, TokenConfig, BiometricConfig
  ```
- [ ] **Definir tipos de errores**
  ```typescript
  // AuthError, TokenError, BiometricError
  ```

#### üîÑ **Mappers Bidireccionales**
- [ ] **UserMapper**: API.User ‚Üî App.User
- [ ] **AuthMapper**: API auth responses ‚Üî App auth models
- [ ] **TokenMapper**: API tokens ‚Üî App token models
- [ ] **ErrorMapper**: API errors ‚Üî App friendly errors

---

### üõ°Ô∏è **FASE 3: SEGURIDAD Y ALMACENAMIENTO**

#### üîê **TokenManager Service**
- [ ] **Implementar almacenamiento seguro**
  - [ ] Access Token ‚Üí EncryptedStorage (15 min TTL)
  - [ ] Refresh Token ‚Üí SecureStore + biometr√≠a (7 d√≠as TTL)
  - [ ] Device ID ‚Üí AsyncStorage (persistente)
- [ ] **Validaci√≥n de tokens**
  - [ ] Verificar expiraci√≥n JWT local
  - [ ] Validar formato y estructura
  - [ ] Auto-cleanup de tokens expirados
- [ ] **Rotaci√≥n de tokens**
  - [ ] L√≥gica de refresh autom√°tico
  - [ ] Manejo de refresh token expirado
  - [ ] Invalidaci√≥n en logout

#### üîí **BiometricManager Service**
- [ ] **Detecci√≥n de capacidades**
  - [ ] Verificar hardware biom√©trico disponible
  - [ ] Detectar tipos soportados (Face ID, Touch ID, etc.)
  - [ ] Verificar enrollment del usuario
- [ ] **Autenticaci√≥n biom√©trica**
  - [ ] Prompt personalizado por plataforma
  - [ ] Fallback a PIN/contrase√±a
  - [ ] Manejo de errores y cancelaciones
- [ ] **Configuraci√≥n de usuario**
  - [ ] Habilitar/deshabilitar biometr√≠a
  - [ ] Preferencias de autenticaci√≥n
  - [ ] Reset en cambio de biometr√≠a

---

### üåê **FASE 4: CLIENTE HTTP Y API**

#### ‚ö° **ApiClient Service - √öNICO CLIENTE HTTP**
- [ ] **Configuraci√≥n base Axios (Cliente √∫nico para toda la app)**
  - [ ] Base URL din√°mica (dev/prod)
  - [ ] Timeout configurables
  - [ ] Headers por defecto (`x-platform: mobile`)
  - [ ] **IMPORTANTE: Este ser√° el √öNICO cliente HTTP usado en toda la app**
- [ ] **Request Interceptors**
  - [ ] Agregar Bearer token autom√°ticamente
  - [ ] Agregar device ID a requests
  - [ ] Logging de requests (solo desarrollo)
- [ ] **Response Interceptors**
  - [ ] Auto-refresh en 401 (solo una vez simult√°nea)
  - [ ] Manejo de errores de red
  - [ ] Logout autom√°tico en errores cr√≠ticos
- [ ] **Retry Logic**
  - [ ] Exponential backoff
  - [ ] M√°ximo de reintentos por tipo de error
  - [ ] Evitar retry en errores 400/401/403
- [ ] **Helpers y utilidades para el cliente existente**
  - [ ] Helper para GET requests
  - [ ] Helper para POST requests
  - [ ] Helper para PUT/PATCH requests
  - [ ] Helper para DELETE requests
  - [ ] Helper para upload de archivos

#### üîó **AuthService**
- [ ] **Implementar todos los endpoints del backend**
  - [ ] `POST /auth/login` - Login con email/username
  - [ ] `POST /auth/register` - Registro completo
  - [ ] `POST /auth/refresh` - Renovar tokens
  - [ ] `POST /auth/logout` - Logout del dispositivo
  - [ ] `POST /auth/logout-all` - Logout todos los dispositivos
  - [ ] `GET /auth/me` - Perfil del usuario
  - [ ] `POST /auth/change-password` - Cambiar contrase√±a
  - [ ] `POST /auth/forgot-password` - Solicitar reset
  - [ ] `POST /auth/reset-password` - Reset con token
  - [ ] `POST /auth/verify-email` - Verificar email
- [ ] **Manejo de dispositivos**
  - [ ] Enviar deviceId en todas las requests
  - [ ] Recopilar device info (OS, modelo, etc.)
  - [ ] Platform detection autom√°tica
- [ ] **Validaciones locales**
  - [ ] Validar formato de email
  - [ ] Validar fortaleza de contrase√±a
  - [ ] Validar disponibilidad de username

---

### üìä **FASE 5: GESTI√ìN DE ESTADO**

#### üè™ **AuthStore (Zustand)**
- [ ] **Estado del usuario autenticado**
  ```typescript
  interface AuthState {
    user: App.User | null
    isAuthenticated: boolean
    isInitialized: boolean
    authMethod: 'password' | 'biometric' | null
  }
  ```
- [ ] **Acciones de autenticaci√≥n**
  - [ ] `setUser(user)` - Establecer usuario
  - [ ] `logout()` - Limpiar estado y tokens
  - [ ] `reset()` - Reset completo del estado
  - [ ] `setAuthMethod(method)` - M√©todo usado
- [ ] **Persistencia del estado**
  - [ ] Persistir solo datos no sensibles
  - [ ] Hydrataci√≥n desde storage al iniciar
  - [ ] Limpieza autom√°tica en logout

#### üóÉÔ∏è **AppStore (Zustand)**
- [ ] **Estado de la aplicaci√≥n**
  ```typescript
  interface AppState {
    isFirstLaunch: boolean
    biometricsEnabled: boolean
    selectedLanguage: string
    theme: 'light' | 'dark' | 'auto'
    notificationsEnabled: boolean
  }
  ```
- [ ] **Configuraciones de usuario**
  - [ ] Preferencias de autenticaci√≥n
  - [ ] Configuraciones de seguridad
  - [ ] Preferencias de UI/UX

---

### üé£ **FASE 6: HOOKS PERSONALIZADOS**

#### üîê **useAuth Hook**
- [ ] **Funcionalidades principales**
  - [ ] `login(credentials)` - Login con credenciales
  - [ ] `loginWithBiometrics()` - Login biom√©trico
  - [ ] `register(userData)` - Registro completo
  - [ ] `logout(allDevices?)` - Logout con opciones
  - [ ] `changePassword(data)` - Cambio de contrase√±a
- [ ] **Estado reactivo**
  - [ ] `user` - Usuario actual
  - [ ] `isAuthenticated` - Estado de auth
  - [ ] `isLoading` - Estado de carga
  - [ ] `error` - Errores de autenticaci√≥n
- [ ] **Integraciones**
  - [ ] TanStack Query para mutations
  - [ ] Zustand para estado local
  - [ ] Biometric service integrado

#### üîí **useBiometric Hook**
- [ ] **Capacidades biom√©tricas**
  - [ ] `isSupported` - Hardware disponible
  - [ ] `isEnrolled` - Usuario configurado
  - [ ] `canUseBiometrics` - Listo para usar
  - [ ] `biometricType` - Tipo disponible
- [ ] **Autenticaci√≥n**
  - [ ] `authenticate()` - Trigger biom√©trico
  - [ ] `enableBiometrics()` - Configurar por primera vez
  - [ ] `disableBiometrics()` - Deshabilitar feature

#### üéØ **useAuthQueries Hook**
- [ ] **Queries relacionadas**
  - [ ] `useUserProfile()` - Perfil completo
  - [ ] `useUserSessions()` - Sesiones activas
  - [ ] `useSecuritySettings()` - Configuraciones
- [ ] **Invalidaciones inteligentes**
  - [ ] Refresh autom√°tico post-login
  - [ ] Limpieza post-logout
  - [ ] Sincronizaci√≥n cross-tabs (si aplica)

---

### üé® **FASE 7: COMPONENTES DE UI**

#### üì± **Pantallas de Autenticaci√≥n**
- [ ] **LoginScreen**
  - [ ] Formulario email/password
  - [ ] Bot√≥n biom√©trico (si disponible)
  - [ ] Link a registro y forgot password
  - [ ] Manejo de errores inline
- [ ] **RegisterScreen**
  - [ ] Formulario completo con validaciones
  - [ ] Verificaci√≥n de email/username disponible
  - [ ] T√©rminos y condiciones
  - [ ] Confirmaci√≥n de password
- [ ] **ForgotPasswordScreen**
  - [ ] Input de email
  - [ ] Env√≠o de c√≥digo/link
  - [ ] Estados de loading y √©xito
- [ ] **BiometricSetupScreen**
  - [ ] Explicaci√≥n de beneficios
  - [ ] Configuraci√≥n inicial
  - [ ] Testing de funcionalidad

#### üß© **Componentes Reutilizables**
- [ ] **BiometricButton**
  - [ ] Icono din√°mico seg√∫n tipo
  - [ ] Estados loading/disabled
  - [ ] Animaciones de feedback
- [ ] **AuthForm**
  - [ ] Validaciones en tiempo real
  - [ ] Accessibility completo
  - [ ] Responsive design
- [ ] **SecureInput**
  - [ ] Toggle password visibility
  - [ ] Strength indicator
  - [ ] Copy/paste protections
- [ ] **AuthGuard**
  - [ ] HOC para proteger rutas
  - [ ] Redirecci√≥n inteligente
  - [ ] Loading states

---

### üîÑ **FASE 8: FLUJOS DE AUTENTICACI√ìN**

#### üöÄ **Inicializaci√≥n de la App**
- [ ] **App startup sequence**
  1. [ ] Verificar tokens en storage
  2. [ ] Validar access token
  3. [ ] Auto-refresh si es necesario
  4. [ ] Cargar usuario si auth v√°lida
  5. [ ] Decidir pantalla inicial
- [ ] **Hydrataci√≥n de estado**
  - [ ] Sincronizar Zustand stores
  - [ ] Inicializar TanStack Query
  - [ ] Configurar biometric availability

#### üîê **Flujo de Login**
- [ ] **Login tradicional**
  1. [ ] Validar credenciales localmente
  2. [ ] Enviar request al backend
  3. [ ] Almacenar tokens securely
  4. [ ] Actualizar estado global
  5. [ ] Invalidar queries relacionadas
  6. [ ] Navegar a pantalla principal
- [ ] **Login biom√©trico**
  1. [ ] Verificar disponibilidad biom√©trica
  2. [ ] Trigger autenticaci√≥n biom√©trica
  3. [ ] Recuperar tokens de SecureStore
  4. [ ] Validar tokens recuperados
  5. [ ] Auto-refresh si es necesario
  6. [ ] Actualizar estado y navegar

#### üìù **Flujo de Registro**
- [ ] **Registro completo**
  1. [ ] Validaciones progresivas
  2. [ ] Verificar disponibilidad email/username
  3. [ ] Crear cuenta en backend
  4. [ ] Auto-login post-registro
  5. [ ] Configurar biometr√≠a (opcional)
  6. [ ] Onboarding inicial

#### üö™ **Flujo de Logout**
- [ ] **Logout local**
  1. [ ] Notificar al backend
  2. [ ] Limpiar tokens de storage
  3. [ ] Reset estado global
  4. [ ] Limpiar cache de queries
  5. [ ] Navegar a login
- [ ] **Logout de todos los dispositivos**
  1. [ ] Request al endpoint logout-all
  2. [ ] Manejo de errors gracefully
  3. [ ] Limpieza local completa

---

### üõ°Ô∏è **FASE 9: SEGURIDAD AVANZADA**

#### üîí **Protecciones adicionales**
- [ ] **Detecci√≥n de root/jailbreak**
  - [ ] Verificar integridad del dispositivo
  - [ ] Warning al usuario si detectado
  - [ ] Restricciones opcionales
- [ ] **Certificate pinning**
  - [ ] Validar certificados SSL
  - [ ] Prevenir man-in-the-middle
- [ ] **Ofuscaci√≥n de c√≥digo**
  - [ ] Proteger l√≥gica sensible
  - [ ] Evitar reverse engineering
- [ ] **Rate limiting local**
  - [ ] L√≠mites de intentos de login
  - [ ] Backoff exponencial
  - [ ] Bloqueo temporal

#### üìä **Logging y monitoreo**
- [ ] **Logs de autenticaci√≥n**
  - [ ] Login attempts (success/failure)
  - [ ] Token refresh events
  - [ ] Biometric usage
  - [ ] Security events
- [ ] **M√©tricas para analytics**
  - [ ] Tiempo de login
  - [ ] M√©todos de auth preferidos
  - [ ] Errores frecuentes
  - [ ] Dispositivos √∫nicos

---

### üöÄ **FASE 10: OPTIMIZACI√ìN Y PERFORMANCE**

#### ‚ö° **Optimizaciones de rendimiento**
- [ ] **Lazy loading**
  - [ ] Componentes de auth bajo demanda
  - [ ] Screens de auth code-splitting
- [ ] **Memoizaci√≥n estrat√©gica**
  - [ ] Hooks computados costosos
  - [ ] Componentes con re-renders frecuentes
- [ ] **Cache inteligente**
  - [ ] User profile cache
  - [ ] Device info cache
  - [ ] Biometric availability cache

#### üì¶ **Bundle optimization**
- [ ] **Tree shaking**
  - [ ] Eliminar c√≥digo no usado
  - [ ] Optimizar imports
- [ ] **Compression**
  - [ ] Optimizar assets
  - [ ] Minimizar bundle size

---

### üìö **FASE 11: DOCUMENTACI√ìN**

#### üìñ **Documentaci√≥n t√©cnica**
- [ ] **API documentation**
  - [ ] Interfaces y tipos
  - [ ] Ejemplos de uso
  - [ ] Error codes
- [ ] **Architecture decision records**
  - [ ] Decisiones de dise√±o
  - [ ] Trade-offs considerados
  - [ ] Alternativas evaluadas
- [ ] **Security documentation**
  - [ ] Threat model
  - [ ] Security measures
  - [ ] Best practices

#### üë• **Documentaci√≥n para desarrolladores**
- [ ] **Setup guide**
  - [ ] Configuraci√≥n inicial
  - [ ] Variables de entorno
  - [ ] Dependencias
- [ ] **Usage examples**
  - [ ] Patrones comunes
  - [ ] Casos de uso t√≠picos
  - [ ] Troubleshooting

---

## üéØ **RESULTADO ESPERADO**

### ‚úÖ **Sistema Completo que Incluye:**
1. **üîê Autenticaci√≥n robusta** con 11 endpoints integrados
2. **üõ°Ô∏è Almacenamiento ultra-seguro** con biometr√≠a
3. **‚ö° Performance optimizada** con TanStack Query + Zustand
4. **üé® UI/UX moderna** siguiendo mejores pr√°cticas
5. **üß™ Testing comprehensivo** con cobertura alta
6. **üì± Compatibilidad total** iOS/Android
7. **üîÑ Auto-refresh inteligente** de tokens
8. **üìä Logging y analytics** integrados
9. **üéØ TypeScript estricto** sin `any`
10. **üìö Documentaci√≥n completa** para mantenimiento

### üöÄ **Beneficios Clave:**
- **Seguridad de grado empresarial** con m√∫ltiples capas
- **Experiencia de usuario fluida** con biometr√≠a
- **Arquitectura escalable** para crecimiento futuro
- **Mantenibilidad alta** con c√≥digo bien estructurado
- **Performance √≥ptima** para dispositivos m√≥viles
- **Compliance** con est√°ndares de seguridad 2025

---

*üéØ CONTEXTO: Sistema de Auth Mobile 2025 | Listo, Coyotito. ¬øEmpezamos con la Fase 1?*